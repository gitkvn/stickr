<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
<title>Stickr â€” P2P File Sharing & Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-primary: #0a0a0f;
  --bg-secondary: #12121a;
  --bg-tertiary: #1a1a28;
  --bg-card: #15152080;
  --border: #2a2a3e;
  --border-glow: #4f46e540;
  --text-primary: #e8e8f0;
  --text-secondary: #8888a8;
  --text-muted: #555570;
  --accent: #6c5ce7;
  --accent-bright: #a29bfe;
  --accent-glow: #6c5ce730;
  --success: #00d2a0;
  --success-glow: #00d2a030;
  --warning: #ffc048;
  --danger: #ff6b6b;
  --gradient-1: linear-gradient(135deg, #6c5ce7, #a29bfe);
  --gradient-2: linear-gradient(135deg, #00d2a0, #00b894);
  --gradient-hero: radial-gradient(ellipse at 30% 20%, #6c5ce712 0%, transparent 50%),
                   radial-gradient(ellipse at 70% 80%, #00d2a008 0%, transparent 50%);
  --font-display: 'Outfit', sans-serif;
  --font-body: 'Outfit', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 12px;
  --radius-lg: 20px;
  --shadow: 0 4px 30px rgba(0,0,0,0.3);
  --shadow-glow: 0 0 40px var(--accent-glow);
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  line-height: 1.6;
}

/* â”€â”€â”€ Background Effects â”€â”€â”€ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: var(--gradient-hero);
  pointer-events: none;
  z-index: 0;
}

.grain-overlay {
  position: fixed;
  inset: 0;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€â”€ Grid Lines (subtle) â”€â”€â”€ */
.grid-bg {
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 80px 80px;
  opacity: 0.04;
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€â”€ Layout â”€â”€â”€ */
.app-container {
  position: relative;
  z-index: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* â”€â”€â”€ Header â”€â”€â”€ */
header {
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(20px);
  background: var(--bg-primary)cc;
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
  text-decoration: none;
  cursor: pointer;
}

.logo-text {
  font-family: var(--font-display);
  font-size: 26px;
  font-weight: 800;
  color: var(--text-primary);
  letter-spacing: -0.5px;
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.logo-text .peel-wrap {
  position: relative;
  display: inline-block;
}

.logo-text .base {
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-text .peel {
  position: absolute;
  top: -1px;
  right: -2px;
  width: 18px;
  height: 16px;
  overflow: hidden;
  pointer-events: none;
}

.logo-text .peel::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 18px;
  height: 16px;
  background: linear-gradient(225deg, var(--bg-primary) 40%, var(--accent) 42%, var(--accent-bright) 60%, #c4b5fd 80%);
  border-radius: 0 0 0 6px;
  box-shadow: -2px 2px 4px rgba(0,0,0,0.35);
  transform: rotate(0deg);
}

.logo-text .peel::after {
  content: '';
  position: absolute;
  top: 0;
  right: 9px;
  width: 10px;
  height: 7px;
  background: linear-gradient(180deg, rgba(108,92,231,0.08) 0%, transparent 100%);
  filter: blur(1px);
}

.header-badge {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 20px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* â”€â”€â”€ Views â”€â”€â”€ */
.view {
  display: none;
  flex: 1;
  animation: fadeIn 0.4s ease;
}
.view.active { display: flex; flex-direction: column; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* â”€â”€â”€ Home View â”€â”€â”€ */
.home-view {
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  gap: 50px;
}

.hero {
  text-align: center;
  max-width: 680px;
}

.hero h1 {
  font-family: var(--font-display);
  font-size: clamp(38px, 6vw, 64px);
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 20px;
  letter-spacing: -2px;
}

.hero h1 .highlight {
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hero p {
  font-size: 18px;
  color: var(--text-secondary);
  max-width: 500px;
  margin: 0 auto;
  line-height: 1.7;
}

.actions {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn {
  font-family: var(--font-body);
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: var(--radius);
  padding: 14px 32px;
  cursor: pointer;
  transition: all 0.25s ease;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.2px;
}

.btn-primary {
  background: var(--gradient-1);
  color: white;
  box-shadow: 0 4px 24px var(--accent-glow), 0 0 0 1px rgba(108,92,231,0.3);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 32px var(--accent-glow), 0 0 0 1px rgba(108,92,231,0.5);
}

.btn-secondary {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border);
}
.btn-secondary:hover {
  background: var(--bg-card);
  border-color: var(--accent);
  transform: translateY(-2px);
}

.btn-icon {
  font-size: 18px;
}

/* â”€â”€â”€ Join Modal â”€â”€â”€ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 36px;
  width: 90%;
  max-width: 420px;
  box-shadow: var(--shadow);
}

.modal h2 {
  font-family: var(--font-display);
  font-size: 24px;
  margin-bottom: 8px;
  font-weight: 700;
}

.modal p {
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-size: 14px;
}

.input-group {
  display: flex;
  gap: 10px;
}

.input {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 18px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 18px;
  outline: none;
  letter-spacing: 4px;
  text-align: center;
  text-transform: lowercase;
  transition: border-color 0.2s;
}
.input:focus { border-color: var(--accent); }
.input::placeholder { letter-spacing: 1px; color: var(--text-muted); font-size: 14px; }

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.modal-actions .btn { flex: 1; justify-content: center; }

/* â”€â”€â”€ Features â”€â”€â”€ */
.features {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  max-width: 700px;
  width: 100%;
  padding: 0 20px;
}

.feature-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  backdrop-filter: blur(10px);
  transition: border-color 0.3s;
}
.feature-card:hover { border-color: var(--accent); }

.feature-icon { font-size: 28px; margin-bottom: 10px; }
.feature-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.feature-card p { font-size: 12px; color: var(--text-secondary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â”€â”€â”€ Room View â”€â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.room-view {
  flex: 1;
}

.room-layout {
  display: grid;
  grid-template-columns: 1fr 380px;
  flex: 1;
  height: calc(100vh - 65px);
  overflow: hidden;
}

/* â”€â”€â”€ File Panel â”€â”€â”€ */
.file-panel {
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  overflow: hidden;
}

.panel-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.panel-title {
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.room-code {
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--accent-bright);
  flex-shrink: 0;
}
.room-code:hover { border-color: var(--accent); background: var(--accent-glow); }

.connection-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-muted);
}
.status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success-glow); }
.status-dot.waiting { background: var(--warning); animation: pulse 1.5s infinite; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* â”€â”€â”€ Drop Zone â”€â”€â”€ */
.drop-zone-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 24px;
  overflow-y: auto;
}

.drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  padding: 48px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: var(--bg-card);
  position: relative;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-glow);
  box-shadow: inset 0 0 40px var(--accent-glow);
}

.drop-zone-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.8;
}

.drop-zone h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 6px;
}

.drop-zone p {
  font-size: 13px;
  color: var(--text-secondary);
}

.file-input { display: none; }

/* â”€â”€â”€ File List â”€â”€â”€ */
.file-list {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.file-item {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 18px;
  display: flex;
  align-items: center;
  gap: 14px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.file-type-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 14px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-size { font-size: 12px; color: var(--text-secondary); }

.file-progress {
  width: 100%;
  height: 4px;
  background: var(--bg-tertiary);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}

.file-progress-bar {
  height: 100%;
  background: var(--gradient-1);
  border-radius: 2px;
  transition: width 0.3s;
  width: 0%;
}

.file-status {
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  flex-shrink: 0;
}
.file-status.complete { color: var(--success); }
.file-status.sending { color: var(--accent-bright); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â”€â”€â”€ Chat Panel â”€â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-panel {
  display: flex;
  flex-direction: column;
  background: var(--bg-secondary);
  overflow: hidden;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.chat-msg {
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 14px;
  line-height: 1.5;
  animation: msgPop 0.2s ease;
  word-wrap: break-word;
  overflow-wrap: break-word;
  box-sizing: border-box;
}

@keyframes msgPop {
  from { opacity: 0; transform: scale(0.95) translateY(4px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.chat-msg.sent {
  align-self: flex-end;
  background: var(--accent);
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-msg.received {
  align-self: flex-start;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.chat-msg.system {
  align-self: center;
  background: transparent;
  color: var(--text-muted);
  font-size: 12px;
  font-family: var(--font-mono);
  padding: 4px 12px;
}

.chat-msg .msg-time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 4px;
  display: block;
}

.empty-chat {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  gap: 8px;
}
.empty-chat .empty-icon { font-size: 36px; opacity: 0.5; }
.empty-chat p { font-size: 13px; }

.chat-input-area {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}

.chat-input {
  flex: 1;
  font-family: var(--font-body);
  font-size: 14px;
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 12px 18px;
  outline: none;
  transition: border-color 0.2s;
}
.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-muted); }

.chat-send {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--gradient-1);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: transform 0.2s, box-shadow 0.2s;
  flex-shrink: 0;
}
.chat-send:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent-glow); }
.chat-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* â”€â”€â”€ Share Link Bar â”€â”€â”€ */
.share-bar {
  padding: 14px 24px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.share-bar .share-label {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  flex-shrink: 0;
}

.share-link-input {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 13px;
  background: var(--bg-primary);
  color: var(--accent-bright);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 14px;
  outline: none;
  cursor: pointer;
}

.btn-copy {
  font-family: var(--font-body);
  font-size: 13px;
  font-weight: 600;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 18px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-copy:hover { border-color: var(--accent); }
.btn-copy.copied { background: var(--success); border-color: var(--success); color: #0a0a0f; }

/* â”€â”€â”€ Error Toast â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--danger);
  color: white;
  padding: 12px 24px;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  z-index: 999;
  transition: transform 0.3s ease;
  box-shadow: 0 4px 24px rgba(255,107,107,0.3);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* â”€â”€â”€ Scrollbar â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* â”€â”€â”€ Responsive â”€â”€â”€ */
/* â”€â”€â”€ Mobile Tab Bar â”€â”€â”€ */
.mobile-tabs {
  display: none;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
  align-items: center;
}

.mobile-tabs button {
  flex: 1;
  font-family: var(--font-body);
  font-size: 14px;
  font-weight: 600;
  padding: 12px 0;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
}

.mobile-tabs button.active {
  color: var(--accent-bright);
  border-bottom-color: var(--accent);
}

.mobile-status {
  display: flex;
  align-items: center;
  gap: 6px;
  padding-right: 12px;
  flex-shrink: 0;
}

.room-code-mini {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent-bright);
  cursor: pointer;
}

@media (max-width: 860px) {
  .mobile-tabs {
    display: flex;
  }
  /* Hide main header in room view to save space on mobile */
  body.in-room header {
    display: none;
  }
  .room-layout {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
    height: calc(100dvh - 46px);
  }
  .file-panel {
    display: none;
    border-right: none;
  }
  .chat-panel {
    display: none;
  }
  .file-panel.mobile-active {
    display: flex;
  }
  .chat-panel.mobile-active {
    display: flex;
  }
  /* Hide duplicate panel header on mobile â€” tabs already show which panel */
  .chat-panel .panel-header {
    display: none;
  }
  .file-panel .panel-header .connection-status {
    display: flex;
  }
  /* Fix chat input area padding and safe area for browser bars */
  .chat-input-area {
    padding: 12px 16px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  }
  .chat-messages {
    padding: 16px;
  }
  .chat-msg {
    max-width: 80%;
  }
}

@media (max-width: 600px) {
  header { padding: 14px 16px; }
  .hero h1 { letter-spacing: -1px; }
  .features { grid-template-columns: 1fr 1fr; }
  .share-bar { flex-wrap: wrap; }
  .panel-header { padding: 12px 16px; }
  .drop-zone-container { padding: 16px; }
  .drop-zone { padding: 32px 16px; }
  .chat-input-area {
    padding: 10px 12px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
    gap: 8px;
  }
  .chat-input {
    padding: 10px 14px;
    font-size: 16px; /* prevents iOS zoom on focus */
  }
  .chat-send {
    width: 40px;
    height: 40px;
    min-width: 40px;
    font-size: 16px;
  }
}
</style>
</head>
<body>

<div class="grain-overlay"></div>
<div class="grid-bg"></div>

<div class="app-container">
  <header>
    <div class="logo" onclick="goHome()">
      <div class="logo-text">
        <span class="peel-wrap">
          <span class="base">Stickr</span>
          <span class="peel"></span>
        </span>
      </div>
    </div>
    <div class="header-badge">P2P Encrypted</div>
  </header>

  <!-- â•â•â• HOME VIEW â•â•â• -->
  <div id="home-view" class="view home-view active">
    <div class="hero">
      <h1>Share files <span class="highlight">directly.</span><br>Chat <span class="highlight">privately.</span></h1>
      <p>Peer-to-peer file sharing and encrypted chat. No uploads, no storage, no sign-ups. Files go straight from you to them.</p>
    </div>

    <div class="actions">
      <button class="btn btn-primary" onclick="createRoom()">
        <span class="btn-icon">ğŸ“¤</span> Share Files
      </button>
      <button class="btn btn-secondary" onclick="showJoinModal()">
        <span class="btn-icon">ğŸ“¥</span> Receive / Join
      </button>
    </div>

    <div class="features">
      <div class="feature-card">
        <div class="feature-icon">ğŸ”—</div>
        <h3>Peer-to-Peer</h3>
        <p>Direct device-to-device transfer via WebRTC</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ”’</div>
        <h3>Encrypted</h3>
        <p>End-to-end encrypted with DTLS</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ’¬</div>
        <h3>Live Chat</h3>
        <p>Real-time P2P messaging alongside file transfers</p>
      </div>
      <div class="feature-card">
        <div class="feature-icon">ğŸ“¦</div>
        <h3>Up to 500 MB</h3>
        <p>Send large files reliably, no sign-up needed</p>
      </div>
    </div>
  </div>

  <!-- â•â•â• ROOM VIEW â•â•â• -->
  <div id="room-view" class="view room-view">
    <div class="mobile-tabs" id="mobile-tabs">
      <button class="active" onclick="switchMobileTab('files')">ğŸ“ Files</button>
      <button onclick="switchMobileTab('chat')">ğŸ’¬ Chat</button>
      <div class="mobile-status" id="mobile-status">
        <div class="status-dot" id="mobile-status-dot"></div>
        <span class="room-code-mini" id="mobile-room-code" onclick="copyRoomCode()"></span>
      </div>
    </div>
    <div class="room-layout">
      <!-- File Panel -->
      <div class="file-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸ“ Files</div>
          <div class="connection-status">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Waiting...</span>
          </div>
        </div>
        <div class="drop-zone-container">
          <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" class="file-input" multiple>
            <div class="drop-zone-icon">ğŸ“‚</div>
            <h3>Drop files here</h3>
            <p>or click to browse â€” up to 500 MB per file</p>
          </div>
          <div class="file-list" id="file-list"></div>
        </div>
        <div class="share-bar" id="share-bar" style="display:none">
          <span class="share-label">Share Link</span>
          <input class="share-link-input" id="share-link" readonly onclick="this.select()">
          <button class="btn-copy" id="copy-btn" onclick="copyLink()">Copy</button>
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="chat-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸ’¬ Chat</div>
          <div class="room-code" id="room-code-display" onclick="copyRoomCode()" style="display:none">
            <span id="room-code-text"></span>
            <span style="font-size:12px">ğŸ“‹</span>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="empty-chat">
            <div class="empty-icon">ğŸ’¬</div>
            <p>Messages will appear here</p>
            <p style="font-size:11px; color: var(--text-muted)">All messages are peer-to-peer encrypted</p>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." disabled>
          <button class="chat-send" id="chat-send" onclick="sendChatMessage()" disabled>â¤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Join Modal -->
<div class="modal-overlay" id="join-modal">
  <div class="modal">
    <h2>Join a Room</h2>
    <p>Enter the 6-character room code to connect</p>
    <input class="input" id="room-code-input" maxlength="6" placeholder="abc123" autofocus>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideJoinModal()">Cancel</button>
      <button class="btn btn-primary" onclick="joinRoom()">Connect</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws = null;
let myPeerId = null;
let roomId = null;
let isHost = false;
const peers = new Map();       // peerId -> { pc, dataChannel, chatChannel }
const CHUNK_SIZE = 64 * 1024;  // 64KB chunks
const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB limit
const ICE_SERVERS = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  {
    urls: 'stun:stun.relay.metered.ca:80',
  },
  {
    urls: 'turn:global.relay.metered.ca:80',
    username: 'bf9a8ea3ca75197c263cb946',
    credential: 'Z9oX9oE+QeZcjJ79',
  },
  {
    urls: 'turn:global.relay.metered.ca:80?transport=tcp',
    username: 'bf9a8ea3ca75197c263cb946',
    credential: 'Z9oX9oE+QeZcjJ79',
  },
  {
    urls: 'turn:global.relay.metered.ca:443',
    username: 'bf9a8ea3ca75197c263cb946',
    credential: 'Z9oX9oE+QeZcjJ79',
  },
  {
    urls: 'turns:global.relay.metered.ca:443?transport=tcp',
    username: 'bf9a8ea3ca75197c263cb946',
    credential: 'Z9oX9oE+QeZcjJ79',
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET / SIGNALING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectWS() {
  return new Promise((resolve, reject) => {
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${proto}://${location.host}`);

    // Timeout if WebSocket doesn't connect within 10 seconds
    const timeout = setTimeout(() => {
      ws.close();
      reject(new Error('Connection timed out'));
    }, 10000);

    ws.onopen = () => {
      clearTimeout(timeout);
      resolve();
    };
    ws.onerror = () => {
      clearTimeout(timeout);
      reject(new Error('WebSocket connection failed'));
    };
    ws.onclose = () => {
      console.log('WS closed');
    };
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      handleSignalingMessage(msg);
    };
  });
}

function sendSignal(to, signal) {
  ws.send(JSON.stringify({ type: 'signal', to, signal }));
}

function handleSignalingMessage(msg) {
  switch (msg.type) {
    case 'room-created':
      myPeerId = msg.peerId;
      roomId = msg.roomId;
      showRoomView();
      break;

    case 'room-joined':
      myPeerId = msg.peerId;
      roomId = msg.roomId;
      showRoomView();
      // Peer initiates WebRTC connection to host
      createPeerConnection(msg.hostId, true);
      break;

    case 'peer-joined':
      // Host receives new peer
      createPeerConnection(msg.peerId, false);
      break;

    case 'signal':
      handleRTCSignal(msg.from, msg.signal);
      break;

    case 'host-disconnected':
      showToast('Host disconnected â€” files are no longer available');
      updateStatus('disconnected');
      break;

    case 'peer-disconnected':
      const peer = peers.get(msg.peerId);
      if (peer) {
        peer.pc.close();
        peers.delete(msg.peerId);
      }
      addSystemMessage('A peer disconnected');
      updatePeerCount();
      break;

    case 'error':
      showToast(msg.message);
      break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBRTC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONNECTION_TIMEOUT = 15000; // 15 seconds to connect before retrying

function createPeerConnection(remotePeerId, initiator) {
  const pc = new RTCPeerConnection({
    iceServers: ICE_SERVERS,
    iceCandidatePoolSize: 4,  // pre-gather candidates for faster connection
  });
  const peerObj = { pc, dataChannel: null, chatChannel: null, connectionTimer: null };
  peers.set(remotePeerId, peerObj);

  // Start connection timeout
  peerObj.connectionTimer = setTimeout(() => {
    if (pc.connectionState !== 'connected') {
      console.log('Connection timeout â€” retrying...');
      addSystemMessage('Connection slow â€” retrying...');
      pc.close();
      peers.delete(remotePeerId);
      createPeerConnection(remotePeerId, initiator);
    }
  }, CONNECTION_TIMEOUT);

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      sendSignal(remotePeerId, { type: 'ice-candidate', candidate: e.candidate });
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === 'connected') {
      clearTimeout(peerObj.connectionTimer);
      updateStatus('connected');
      addSystemMessage('Peer connected â€” you can now chat and share files!');
      enableChat();
    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
      clearTimeout(peerObj.connectionTimer);
      updateStatus('disconnected');
    }
  };

  // Speed up ICE by also watching the ICE connection state
  pc.oniceconnectionstatechange = () => {
    if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
      clearTimeout(peerObj.connectionTimer);
    }
  };

  if (initiator) {
    // Create data channels
    const fileChannel = pc.createDataChannel('file-transfer', { ordered: true });
    const chatChannel = pc.createDataChannel('chat', { ordered: true });
    peerObj.dataChannel = fileChannel;
    peerObj.chatChannel = chatChannel;
    setupFileChannel(fileChannel, remotePeerId);
    setupChatChannel(chatChannel);

    pc.createOffer().then(offer => {
      pc.setLocalDescription(offer);
      sendSignal(remotePeerId, { type: 'offer', sdp: offer });
    });
  } else {
    pc.ondatachannel = (e) => {
      if (e.channel.label === 'file-transfer') {
        peerObj.dataChannel = e.channel;
        setupFileChannel(e.channel, remotePeerId);
      } else if (e.channel.label === 'chat') {
        peerObj.chatChannel = e.channel;
        setupChatChannel(e.channel);
      }
    };
  }
}

async function handleRTCSignal(from, signal) {
  let peer = peers.get(from);
  if (!peer) {
    createPeerConnection(from, false);
    peer = peers.get(from);
  }

  const pc = peer.pc;

  if (signal.type === 'offer') {
    await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    sendSignal(from, { type: 'answer', sdp: answer });
  } else if (signal.type === 'answer') {
    await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
  } else if (signal.type === 'ice-candidate') {
    await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE TRANSFER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let incomingFiles = {};
let currentReceivingFileId = null;

function setupFileChannel(channel, remotePeerId) {
  channel.binaryType = 'arraybuffer';

  channel.onmessage = (e) => {
    if (typeof e.data === 'string') {
      const msg = JSON.parse(e.data);
      if (msg.type === 'file-meta') {
        incomingFiles[msg.id] = {
          name: msg.name,
          size: msg.size,
          mimeType: msg.mimeType,
          chunks: [],
          received: 0,
        };
        currentReceivingFileId = msg.id;
        addFileItem(msg.id, msg.name, msg.size, 'receiving');
      } else if (msg.type === 'file-complete') {
        const file = incomingFiles[msg.id];
        if (file) {
          const blob = new Blob(file.chunks, { type: file.mimeType || 'application/octet-stream' });
          downloadBlob(blob, file.name);
          updateFileStatus(msg.id, 'complete');
          delete incomingFiles[msg.id];
          currentReceivingFileId = null;
        }
      }
    } else {
      // Binary chunk â€” append to the file we're currently receiving
      if (currentReceivingFileId && incomingFiles[currentReceivingFileId]) {
        const file = incomingFiles[currentReceivingFileId];
        file.chunks.push(e.data);
        file.received += e.data.byteLength;
        const pct = Math.round((file.received / file.size) * 100);
        updateFileProgress(currentReceivingFileId, pct);
      }
    }
  };
}

async function sendFile(file) {
  const fileId = 'f-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);

  addFileItem(fileId, file.name, file.size, 'sending');

  for (const [, peer] of peers) {
    const ch = peer.dataChannel;
    if (!ch || ch.readyState !== 'open') continue;

    // Send metadata
    ch.send(JSON.stringify({
      type: 'file-meta',
      id: fileId,
      name: file.name,
      size: file.size,
      mimeType: file.type,
    }));

    // Send chunks
    const reader = file.stream().getReader();
    let sent = 0;

    const sendChunks = async () => {
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        // Split value into CHUNK_SIZE pieces
        let offset = 0;
        while (offset < value.byteLength) {
          const chunk = value.slice(offset, offset + CHUNK_SIZE);
          // Backpressure
          while (ch.bufferedAmount > 4 * CHUNK_SIZE) {
            await new Promise(r => setTimeout(r, 20));
          }
          ch.send(chunk);
          sent += chunk.byteLength;
          offset += chunk.byteLength;
          const pct = Math.round((sent / file.size) * 100);
          updateFileProgress(fileId, pct);
        }
      }
    };

    await sendChunks();

    ch.send(JSON.stringify({ type: 'file-complete', id: fileId }));
    updateFileStatus(fileId, 'complete');
  }
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupChatChannel(channel) {
  channel.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === 'chat') {
        addChatMessage(msg.text, 'received', msg.time);
      }
    } catch {}
  };

  channel.onopen = () => enableChat();
}

function sendChatMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const msg = JSON.stringify({ type: 'chat', text, time });

  for (const [, peer] of peers) {
    if (peer.chatChannel && peer.chatChannel.readyState === 'open') {
      peer.chatChannel.send(msg);
    }
  }

  addChatMessage(text, 'sent', time);
  input.value = '';
  input.focus();
}

function enableChat() {
  document.getElementById('chat-input').disabled = false;
  document.getElementById('chat-send').disabled = false;
  document.getElementById('chat-input').placeholder = 'Type a message...';

  // Clear empty state
  const msgs = document.getElementById('chat-messages');
  const empty = msgs.querySelector('.empty-chat');
  if (empty) empty.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addChatMessage(text, type, time) {
  const container = document.getElementById('chat-messages');
  const empty = container.querySelector('.empty-chat');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = `chat-msg ${type}`;
  div.innerHTML = `${escapeHtml(text)}<span class="msg-time">${time || ''}</span>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;

  // Flash chat tab on mobile if not viewing chat
  const chatPanel = document.querySelector('.chat-panel');
  if (!chatPanel.classList.contains('mobile-active') && window.innerWidth <= 860) {
    const chatTab = document.querySelectorAll('#mobile-tabs button')[1];
    if (chatTab && !chatTab.classList.contains('active')) {
      chatTab.style.color = 'var(--success)';
      chatTab.textContent = 'ğŸ’¬ Chat â€¢';
    }
  }
}

function addSystemMessage(text) {
  const container = document.getElementById('chat-messages');
  const empty = container.querySelector('.empty-chat');
  if (empty) empty.remove();

  const div = document.createElement('div');
  div.className = 'chat-msg system';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function getFileIcon(name) {
  const ext = name.split('.').pop().toLowerCase();
  const icons = {
    pdf: 'ğŸ“•', doc: 'ğŸ“„', docx: 'ğŸ“„', txt: 'ğŸ“', csv: 'ğŸ“Š', xls: 'ğŸ“Š', xlsx: 'ğŸ“Š',
    jpg: 'ğŸ–¼ï¸', jpeg: 'ğŸ–¼ï¸', png: 'ğŸ–¼ï¸', gif: 'ğŸï¸', svg: 'ğŸ¨', webp: 'ğŸ–¼ï¸',
    mp4: 'ğŸ¬', mov: 'ğŸ¬', avi: 'ğŸ¬', mkv: 'ğŸ¬', mp3: 'ğŸµ', wav: 'ğŸµ', flac: 'ğŸµ',
    zip: 'ğŸ“¦', rar: 'ğŸ“¦', '7z': 'ğŸ“¦', tar: 'ğŸ“¦', gz: 'ğŸ“¦',
    js: 'âš¡', ts: 'ğŸ”·', py: 'ğŸ', html: 'ğŸŒ', css: 'ğŸ¨', json: 'ğŸ“‹',
    exe: 'âš™ï¸', dmg: 'ğŸ’¿', iso: 'ğŸ’¿', apk: 'ğŸ“±',
  };
  return icons[ext] || 'ğŸ“';
}

function formatSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function addFileItem(id, name, size, status) {
  const list = document.getElementById('file-list');
  const div = document.createElement('div');
  div.className = 'file-item';
  div.id = `file-${id}`;
  div.innerHTML = `
    <div class="file-type-icon">${getFileIcon(name)}</div>
    <div class="file-info">
      <div class="file-name">${escapeHtml(name)}</div>
      <div class="file-size">${formatSize(size)}</div>
      <div class="file-progress"><div class="file-progress-bar" id="progress-${id}"></div></div>
    </div>
    <div class="file-status ${status}" id="status-${id}">${status === 'sending' ? 'Sending...' : 'Receiving...'}</div>
  `;
  list.appendChild(div);
}

function updateFileProgress(id, pct) {
  const bar = document.getElementById(`progress-${id}`);
  if (bar) bar.style.width = pct + '%';
  const status = document.getElementById(`status-${id}`);
  if (status && !status.classList.contains('complete')) {
    status.textContent = pct + '%';
  }
}

function updateFileStatus(id, status) {
  const el = document.getElementById(`status-${id}`);
  if (el) {
    el.className = 'file-status ' + status;
    el.textContent = status === 'complete' ? 'âœ“ Done' : status;
  }
  const bar = document.getElementById(`progress-${id}`);
  if (bar && status === 'complete') bar.style.width = '100%';
}

function updateStatus(state) {
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  const mobileDot = document.getElementById('mobile-status-dot');
  dot.className = 'status-dot';
  if (mobileDot) mobileDot.className = 'status-dot';

  if (state === 'connected') {
    dot.classList.add('connected');
    if (mobileDot) mobileDot.classList.add('connected');
    text.textContent = 'Connected';
  } else if (state === 'waiting') {
    dot.classList.add('waiting');
    if (mobileDot) mobileDot.classList.add('waiting');
    text.textContent = 'Waiting for peer...';
  } else {
    text.textContent = 'Disconnected';
  }
}

function updatePeerCount() {
  // Optional peer count display
}

function showRoomView() {
  document.getElementById('home-view').classList.remove('active');
  document.getElementById('room-view').classList.add('active');
  document.body.classList.add('in-room');

  updateStatus('waiting');

  // Update share link
  const link = `${location.origin}#${roomId}`;
  document.getElementById('share-link').value = link;
  document.getElementById('share-bar').style.display = 'flex';

  // Room code display
  document.getElementById('room-code-display').style.display = 'flex';
  document.getElementById('room-code-text').textContent = roomId;

  // Mobile room code
  const mobileCode = document.getElementById('mobile-room-code');
  if (mobileCode) mobileCode.textContent = roomId;

  // Push hash
  if (!location.hash) {
    history.pushState(null, '', `#${roomId}`);
  }

  // Initialize mobile tabs â€” show files by default
  switchMobileTab('files');
}

function switchMobileTab(tab) {
  const filePanel = document.querySelector('.file-panel');
  const chatPanel = document.querySelector('.chat-panel');
  const tabs = document.querySelectorAll('#mobile-tabs button');

  filePanel.classList.remove('mobile-active');
  chatPanel.classList.remove('mobile-active');
  tabs.forEach(t => t.classList.remove('active'));

  if (tab === 'files') {
    filePanel.classList.add('mobile-active');
    tabs[0].classList.add('active');
  } else {
    chatPanel.classList.add('mobile-active');
    tabs[1].classList.add('active');
    // Clear notification and scroll chat to bottom
    tabs[1].style.color = '';
    tabs[1].textContent = 'ğŸ’¬ Chat';
    const msgs = document.getElementById('chat-messages');
    msgs.scrollTop = msgs.scrollHeight;
  }
}

function goHome() {
  // Clean up connections
  for (const [, peer] of peers) {
    peer.pc.close();
  }
  peers.clear();
  if (ws) ws.close();

  document.getElementById('room-view').classList.remove('active');
  document.getElementById('home-view').classList.add('active');
  document.body.classList.remove('in-room');
  history.pushState(null, '', location.pathname);

  // Reset room state
  document.getElementById('file-list').innerHTML = '';
  document.getElementById('chat-messages').innerHTML = `
    <div class="empty-chat">
      <div class="empty-icon">ğŸ’¬</div>
      <p>Messages will appear here</p>
      <p style="font-size:11px; color: var(--text-muted)">All messages are peer-to-peer encrypted</p>
    </div>
  `;
  document.getElementById('chat-input').disabled = true;
  document.getElementById('chat-send').disabled = true;
  document.getElementById('share-bar').style.display = 'none';
  document.getElementById('room-code-display').style.display = 'none';
}

// â”€â”€â”€ Modal â”€â”€â”€
function showJoinModal() {
  document.getElementById('join-modal').classList.add('active');
  document.getElementById('room-code-input').value = '';
  document.getElementById('room-code-input').focus();
}

function hideJoinModal() {
  document.getElementById('join-modal').classList.remove('active');
}

// â”€â”€â”€ Actions â”€â”€â”€
async function createRoom() {
  try {
    showToastInfo('Connecting to server...');
    await connectWS();
    ws.send(JSON.stringify({ type: 'create-room' }));
    isHost = true;
  } catch (err) {
    showToast('Failed to connect â€” retrying...');
    // Retry once after a short delay
    setTimeout(async () => {
      try {
        await connectWS();
        ws.send(JSON.stringify({ type: 'create-room' }));
        isHost = true;
      } catch (err2) {
        showToast('Server is unavailable. Please try again in a moment.');
      }
    }, 2000);
  }
}

async function joinRoom() {
  const code = document.getElementById('room-code-input').value.trim().toLowerCase();
  if (code.length !== 6) {
    showToast('Please enter a 6-character room code');
    return;
  }
  hideJoinModal();
  try {
    showToastInfo('Connecting to server...');
    await connectWS();
    roomId = code;
    isHost = false;
    ws.send(JSON.stringify({ type: 'join-room', roomId: code }));
  } catch (err) {
    showToast('Failed to connect â€” retrying...');
    setTimeout(async () => {
      try {
        await connectWS();
        roomId = code;
        isHost = false;
        ws.send(JSON.stringify({ type: 'join-room', roomId: code }));
      } catch (err2) {
        showToast('Server is unavailable. Please try again in a moment.');
      }
    }, 2000);
  }
}

function copyLink() {
  const link = document.getElementById('share-link').value;
  navigator.clipboard.writeText(link).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

function copyRoomCode() {
  navigator.clipboard.writeText(roomId).then(() => {
    showToastSuccess('Room code copied!');
  });
}

// â”€â”€â”€ Toast â”€â”€â”€
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.background = 'var(--danger)';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function showToastSuccess(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.background = 'var(--success)';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function showToastInfo(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.background = 'var(--accent)';
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP / FILE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
  handleFiles(e.target.files);
  fileInput.value = '';
});

function handleFiles(files) {
  if (peers.size === 0) {
    showToast('No peers connected yet â€” wait for someone to join!');
    return;
  }
  const validFiles = [];
  for (const file of files) {
    if (file.size > MAX_FILE_SIZE) {
      showToast(`"${file.name}" is too large (${formatSize(file.size)}). Max file size is 500 MB.`);
      continue;
    }
    validFiles.push(file);
  }
  if (validFiles.length > 0) {
    sendFilesSerially(validFiles);
  }
}

async function sendFilesSerially(files) {
  for (const file of files) {
    await sendFile(file);
  }
}

// â”€â”€â”€ Chat Enter Key â”€â”€â”€
document.getElementById('chat-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendChatMessage();
  }
});

// â”€â”€â”€ Join Modal Enter Key â”€â”€â”€
document.getElementById('room-code-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') joinRoom();
});

// â”€â”€â”€ Auto-join from URL hash â”€â”€â”€
window.addEventListener('load', () => {
  const hash = location.hash.slice(1);
  if (hash && hash.length === 6) {
    (async () => {
      try {
        await connectWS();
        roomId = hash;
        isHost = false;
        ws.send(JSON.stringify({ type: 'join-room', roomId: hash }));
      } catch (err) {
        showToastInfo('Connecting...');
        // Retry once â€” handles Railway cold start
        setTimeout(async () => {
          try {
            await connectWS();
            roomId = hash;
            isHost = false;
            ws.send(JSON.stringify({ type: 'join-room', roomId: hash }));
          } catch (err2) {
            showToast('Server is unavailable. Please refresh to try again.');
          }
        }, 3000);
      }
    })();
  }
});

// Mobile keyboard handling â€” adjust layout when keyboard opens/closes
if ('visualViewport' in window) {
  window.visualViewport.addEventListener('resize', () => {
    if (window.innerWidth <= 860) {
      const roomLayout = document.querySelector('.room-layout');
      const mobileTabsHeight = 46;
      const headerHeight = 65;
      if (roomLayout) {
        roomLayout.style.height = `${window.visualViewport.height - headerHeight - mobileTabsHeight}px`;
      }
      // Scroll chat to bottom when keyboard opens
      const msgs = document.getElementById('chat-messages');
      if (msgs) {
        setTimeout(() => { msgs.scrollTop = msgs.scrollHeight; }, 100);
      }
    }
  });
}

// Close modal on overlay click
document.getElementById('join-modal').addEventListener('click', (e) => {
  if (e.target.id === 'join-modal') hideJoinModal();
});
</script>
</body>
</html>
